{% extends 'base.html' %}
{% load static %}

{% block title %}Szczegóły projektu - Workly 2.0{% endblock %}

{% block content %}
<div id="project-detail-content">
    <div class="flex justify-center items-center h-64">
        <span class="loading loading-spinner loading-lg"></span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const projectId = {{ project_id }};
const projectsListUrl = "{% url 'frontend:projects_list' %}";
const projectGanttUrl = (id) => `/projects/${id}/gantt/`;

document.addEventListener('DOMContentLoaded', async function() {
    try {
        const project = await window.WorklyAPI.request(`/projects/${projectId}/`);
        const tasks = await window.WorklyAPI.request(`/tasks/?project=${projectId}`);
        const taskList = tasks.results || tasks;
        
        // Load users to create a map for assignee names
        let usersMap = {};
        try {
            const users = await window.WorklyAPI.request('/users/');
            const userList = Array.isArray(users) ? users : [];
            userList.forEach(user => {
                usersMap[user.id] = user.username;
            });
        } catch (error) {
            console.error('Error loading users:', error);
        }
        
        const content = document.getElementById('project-detail-content');
        content.innerHTML = `
            <div class="mb-6">
                <a href="${projectsListUrl}" class="btn btn-ghost btn-sm mb-4">← Powrót do projektów</a>
                <h1 class="text-3xl font-bold">${project.name}</h1>
                <p class="text-base-content/70">${project.description || 'Brak opisu'}</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="card bg-base-200 shadow-lg">
                        <div class="card-body">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="card-title">Zadania projektu</h2>
                                <button onclick="document.getElementById('create-task-modal').showModal()" class="btn btn-primary btn-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                    Dodaj zadanie
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="table table-zebra">
                                    <thead>
                                        <tr>
                                            <th>Tytuł</th>
                                            <th>Status</th>
                                            <th>Postęp</th>
                                            <th>Przypisany</th>
                                            <th>Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${taskList.length > 0 ? taskList.map(task => {
                                            // Get assignee name - handle both object and ID
                                            let assigneeName = '-';
                                            if (task.assignee) {
                                                if (typeof task.assignee === 'object') {
                                                    assigneeName = task.assignee.username || '-';
                                                } else {
                                                    // task.assignee is an ID, look it up in usersMap
                                                    assigneeName = usersMap[task.assignee] || '-';
                                                }
                                            }
                                            return `
                                            <tr>
                                                <td class="font-semibold">${task.title}</td>
                                                <td>${window.WorklyAPI.getStatusBadge(task.status, 'task')}</td>
                                                <td>
                                                    <div class="flex items-center gap-2">
                                                        <progress class="progress progress-primary w-20" value="${task.progress || 0}" max="100"></progress>
                                                        <span class="text-sm">${task.progress || 0}%</span>
                                                    </div>
                                                </td>
                                                <td>${assigneeName}</td>
                                                <td>
                                                    <div class="flex gap-2">
                                                        <button class="btn btn-sm btn-ghost" onclick="editTask(${task.id})">Edytuj</button>
                                                        <button class="btn btn-sm btn-error" onclick="deleteTask(${task.id}, event)" data-task-title="${(task.title || '').replace(/"/g, '&quot;')}">Usuń</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                        }).join('') : '<tr><td colspan="5" class="text-center">Brak zadań</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="card bg-base-200 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title">Informacje</h2>
                            <div class="space-y-2">
                                <p><strong>Status:</strong> ${window.WorklyAPI.getStatusBadge(project.status, 'project')}</p>
                                <p><strong>Priorytet:</strong> ${window.WorklyAPI.getPriorityBadge(project.priority)}</p>
                                <p><strong>Właściciel:</strong> ${project.owner ? (typeof project.owner === 'object' ? project.owner.username : usersMap[project.owner] || '-') : '-'}</p>
                                <p><strong>Data rozpoczęcia:</strong> ${window.WorklyAPI.formatDate(project.start_date)}</p>
                                <p><strong>Data zakończenia:</strong> ${window.WorklyAPI.formatDate(project.end_date)}</p>
                                <p><strong>Liczba zadań:</strong> ${project.tasks_count || 0}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-base-200 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title">Akcje</h2>
                            <div class="space-y-2">
                                <a href="/projects/${project.id}/dependencies/" class="btn btn-secondary btn-block">Zarządzaj zależnościami</a>
                                <a href="${projectGanttUrl(project.id)}" class="btn btn-primary btn-block">Diagram Gantta</a>
                                <button class="btn btn-ghost btn-block" onclick="editProject()">Edytuj projekt</button>
                                <button class="btn btn-error btn-block" onclick="deleteProject(${project.id}, event)" data-project-name="${(project.name || '').replace(/"/g, '&quot;')}">Usuń projekt</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Setup task modal after content is rendered
        setupTaskModalForProject(projectId, taskList);
        
        // Setup edit task modal
        setupEditTaskModalForProject(projectId, taskList);
        
        // Setup edit project modal
        setupEditProjectModal(project);
    } catch (error) {
        document.getElementById('project-detail-content').innerHTML = `
            <div class="alert alert-error">
                <span>Błąd podczas ładowania projektu: ${error.message}</span>
            </div>
        `;
    }
});

function setupTaskModalForProject(projectId, taskList) {
    // Add modal HTML if not exists
    if (!document.getElementById('create-task-modal')) {
        const modalHTML = `
            <dialog id="create-task-modal" class="modal">
                <div class="modal-box">
                    <h3 class="font-bold text-lg">Nowe zadanie</h3>
                    <form id="create-task-form" class="mt-4 space-y-4">
                        <input type="hidden" name="project" id="task-project" value="${projectId}" />
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Tytuł <span class="text-error">*</span></span>
                            </label>
                            <input type="text" name="title" id="task-title" class="input input-bordered" required maxlength="160" />
                            <label class="label hidden" id="title-error-label">
                                <span class="label-text-alt text-error"></span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Opis</span>
                            </label>
                            <textarea name="description" id="task-description" class="textarea textarea-bordered"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Data rozpoczęcia</span>
                                </label>
                                <input type="date" name="start_date" id="task-start-date" class="input input-bordered" placeholder="dd.mm.rrrr" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Data zakończenia</span>
                                </label>
                                <input type="date" name="end_date" id="task-end-date" class="input input-bordered" placeholder="dd.mm.rrrr" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Status</span>
                                </label>
                                <select name="status" id="task-status" class="select select-bordered">
                                    <option value="todo" selected>Do zrobienia</option>
                                    <option value="in_progress">W toku</option>
                                    <option value="review">Weryfikacja</option>
                                    <option value="done">Zrobione</option>
                                    <option value="blocked">Zablokowane</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Postęp (%)</span>
                                </label>
                                <input type="number" name="progress" id="task-progress" class="input input-bordered" min="0" max="100" value="0" />
                            </div>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Zadanie nadrzędne</span>
                            </label>
                            <select name="parent" id="task-parent" class="select select-bordered">
                                <option value="">Brak (zadanie główne)</option>
                            </select>
                        </div>
                        <div class="modal-action">
                            <button type="button" onclick="document.getElementById('create-task-modal').close()" class="btn">Anuluj</button>
                            <button type="submit" class="btn btn-primary">Utwórz</button>
                        </div>
                    </form>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>zamknij</button>
                </form>
            </dialog>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Populate parent tasks dropdown
        const parentSelect = document.getElementById('task-parent');
        if (parentSelect && taskList) {
            taskList.filter(t => !t.parent).forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                parentSelect.appendChild(option);
            });
        }
        
        // Setup form handler
        const form = document.getElementById('create-task-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Convert empty strings to null for optional fields
                if (!data.parent) data.parent = null;
                if (!data.start_date) data.start_date = null;
                if (!data.end_date) data.end_date = null;
                if (!data.description) data.description = '';
                
                // Convert to integers
                if (data.progress) data.progress = parseInt(data.progress);
                if (data.parent) data.parent = parseInt(data.parent);
                data.project = parseInt(data.project);
                
                try {
                    await window.WorklyAPI.request('/tasks/', {
                        method: 'POST',
                        body: JSON.stringify(data),
                    });
                    
                    document.getElementById('create-task-modal').close();
                    form.reset();
                    // Reload page to show new task
                    location.reload();
                } catch (error) {
                    alert('Błąd podczas tworzenia zadania: ' + error.message);
                }
            });
        }
    }
}

// Edit task function
async function editTask(taskId) {
    try {
        // Load task data
        const task = await window.WorklyAPI.request(`/tasks/${taskId}/`);
        
        // Fill edit form
        document.getElementById('edit-task-id').value = task.id;
        document.getElementById('edit-task-title').value = task.title || '';
        document.getElementById('edit-task-description').value = task.description || '';
        document.getElementById('edit-task-start-date').value = task.start_date || '';
        document.getElementById('edit-task-end-date').value = task.end_date || '';
        document.getElementById('edit-task-status').value = task.status || 'todo';
        document.getElementById('edit-task-progress').value = task.progress || 0;
        
        // Load parent tasks for the project
        await loadParentTasksForEditForm(projectId, task.id);
        if (task.parent) {
            document.getElementById('edit-task-parent').value = typeof task.parent === 'object' ? task.parent.id : task.parent;
        } else {
            document.getElementById('edit-task-parent').value = '';
        }
        
        // Load users and set assignee
        await loadUsersForEditForm();
        if (task.assignee) {
            const assigneeId = typeof task.assignee === 'object' ? task.assignee.id : task.assignee;
            document.getElementById('edit-task-assignee').value = assigneeId || '';
        } else {
            document.getElementById('edit-task-assignee').value = '';
        }
        
        // Open modal
        document.getElementById('edit-task-modal').showModal();
    } catch (error) {
        console.error('Error loading task:', error);
        alert('Błąd podczas ładowania zadania: ' + error.message);
    }
}

// Load users for edit form
async function loadUsersForEditForm() {
    try {
        const users = await window.WorklyAPI.request('/users/');
        const userList = Array.isArray(users) ? users : [];
        const assigneeSelect = document.getElementById('edit-task-assignee');
        
        if (assigneeSelect) {
            const currentValue = assigneeSelect.value;
            assigneeSelect.innerHTML = '<option value="">Brak</option>';
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                assigneeSelect.appendChild(option);
            });
            if (currentValue) {
                assigneeSelect.value = currentValue;
            }
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Load parent tasks for edit form
async function loadParentTasksForEditForm(projectId, excludeTaskId = null) {
    try {
        const tasks = await window.WorklyAPI.request(`/tasks/?project=${projectId}`);
        const taskList = tasks.results || tasks || [];
        const parentSelect = document.getElementById('edit-task-parent');
        
        if (parentSelect) {
            const currentValue = parentSelect.value;
            parentSelect.innerHTML = '<option value="">Brak (zadanie główne)</option>';
            
            // Add tasks without parent as options, excluding the current task
            taskList.filter(t => !t.parent && t.id !== excludeTaskId).forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                parentSelect.appendChild(option);
            });
            
            if (currentValue) {
                parentSelect.value = currentValue;
            }
        }
    } catch (error) {
        console.error('Error loading parent tasks:', error);
    }
}

// Setup edit task modal
function setupEditTaskModalForProject(projectId, taskList) {
    // Add modal HTML if not exists
    if (!document.getElementById('edit-task-modal')) {
        const modalHTML = `
            <dialog id="edit-task-modal" class="modal">
                <div class="modal-box">
                    <h3 class="font-bold text-lg">Edytuj zadanie</h3>
                    <form id="edit-task-form" class="mt-4 space-y-4">
                        <input type="hidden" id="edit-task-id" name="id" />
                        <input type="hidden" name="project" id="edit-task-project" value="${projectId}" />
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Tytuł <span class="text-error">*</span></span>
                            </label>
                            <input type="text" name="title" id="edit-task-title" class="input input-bordered" required maxlength="160" />
                            <label class="label hidden" id="edit-title-error-label">
                                <span class="label-text-alt text-error"></span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Opis</span>
                            </label>
                            <textarea name="description" id="edit-task-description" class="textarea textarea-bordered"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Data rozpoczęcia</span>
                                </label>
                                <input type="date" name="start_date" id="edit-task-start-date" class="input input-bordered" placeholder="dd.mm.rrrr" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Data zakończenia</span>
                                </label>
                                <input type="date" name="end_date" id="edit-task-end-date" class="input input-bordered" placeholder="dd.mm.rrrr" />
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Status</span>
                                </label>
                                <select name="status" id="edit-task-status" class="select select-bordered">
                                    <option value="todo">Do zrobienia</option>
                                    <option value="in_progress">W toku</option>
                                    <option value="review">Weryfikacja</option>
                                    <option value="done">Zrobione</option>
                                    <option value="blocked">Zablokowane</option>
                                </select>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Postęp (%)</span>
                                </label>
                                <input type="number" name="progress" id="edit-task-progress" class="input input-bordered" min="0" max="100" value="0" />
                            </div>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Zadanie nadrzędne</span>
                            </label>
                            <select name="parent" id="edit-task-parent" class="select select-bordered">
                                <option value="">Brak (zadanie główne)</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Przypisany użytkownik</span>
                            </label>
                            <select name="assignee" id="edit-task-assignee" class="select select-bordered">
                                <option value="">Brak</option>
                            </select>
                        </div>
                        <div class="modal-action">
                            <button type="button" onclick="document.getElementById('edit-task-modal').close()" class="btn">Anuluj</button>
                            <button type="submit" class="btn btn-primary">Zapisz</button>
                        </div>
                    </form>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>zamknij</button>
                </form>
            </dialog>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Setup form handler
        const form = document.getElementById('edit-task-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const taskId = document.getElementById('edit-task-id').value;
                if (!taskId) {
                    alert('Błąd: Brak ID zadania');
                    return;
                }
                
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Remove id from data (it's not part of the update)
                delete data.id;
                
                // Convert empty strings to null for optional fields
                if (!data.parent) data.parent = null;
                if (!data.start_date) data.start_date = null;
                if (!data.end_date) data.end_date = null;
                if (!data.description) data.description = '';
                if (!data.assignee) data.assignee = null;
                
                // Convert to integers
                if (data.progress) data.progress = parseInt(data.progress);
                if (data.parent) data.parent = parseInt(data.parent);
                data.project = parseInt(data.project);
                if (data.assignee) data.assignee = parseInt(data.assignee);
                
                try {
                    await window.WorklyAPI.request(`/tasks/${taskId}/`, {
                        method: 'PATCH',
                        body: JSON.stringify(data),
                    });
                    
                    document.getElementById('edit-task-modal').close();
                    form.reset();
                    // Reload page to show updated task
                    location.reload();
                } catch (error) {
                    alert('Błąd podczas aktualizacji zadania: ' + error.message);
                }
            });
        }
    }
}

// Load dependencies for a task (where this task is the successor)
async function loadDependenciesForTask(taskId, projectId) {
    try {
        // Get all dependencies where this task is the successor
        const dependencies = await window.WorklyAPI.request(`/dependencies/?successor=${taskId}`);
        const depsList = dependencies.results || dependencies || [];
        
        const depsContainer = document.getElementById('edit-dependencies-list');
        if (!depsContainer) return;
        
        if (depsList.length === 0) {
            depsContainer.innerHTML = '<p class="text-sm text-base-content/70">Brak zależności</p>';
            return;
        }
        
        // Load all tasks from project to get names
        const tasks = await window.WorklyAPI.request(`/tasks/?project=${projectId}`);
        const taskList = tasks.results || tasks || [];
        const tasksMap = new Map(taskList.map(t => [t.id, t]));
        
        depsContainer.innerHTML = depsList.map(dep => {
            const predecessor = tasksMap.get(dep.predecessor);
            const predName = predecessor ? predecessor.title : `Zadanie #${dep.predecessor}`;
            const typeLabels = {
                'FS': 'Koniec→Start',
                'SS': 'Start→Start',
                'FF': 'Koniec→Koniec',
                'SF': 'Start→Koniec'
            };
            
            return `
                <div class="flex items-center gap-2 p-2 bg-base-300 rounded" data-dependency-id="${dep.id}">
                    <span class="flex-1 text-sm">
                        <strong>${predName}</strong> 
                        <span class="badge badge-sm badge-info ml-2">${dep.type} (${typeLabels[dep.type] || dep.type})</span>
                        ${dep.lag_days ? `<span class="text-xs ml-2">Lag: ${dep.lag_days}d</span>` : ''}
                    </span>
                    <button type="button" class="btn btn-xs btn-error" onclick="removeDependency(${dep.id}, ${taskId})">Usuń</button>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading dependencies:', error);
        const depsContainer = document.getElementById('edit-dependencies-list');
        if (depsContainer) {
            depsContainer.innerHTML = '<p class="text-sm text-error">Błąd podczas ładowania zależności</p>';
        }
    }
}

// Load tasks for dependency predecessor dropdown
async function loadTasksForDependencyDropdown(projectId, excludeTaskId) {
    try {
        const tasks = await window.WorklyAPI.request(`/tasks/?project=${projectId}`);
        const taskList = tasks.results || tasks || [];
        const predecessorSelect = document.getElementById('edit-dependency-predecessor');
        
        if (predecessorSelect) {
            predecessorSelect.innerHTML = '<option value="">Wybierz zadanie poprzedzające</option>';
            taskList.filter(t => t.id !== excludeTaskId).forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                predecessorSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading tasks for dependency dropdown:', error);
    }
}

// Add dependency
async function addDependency(taskId) {
    const predecessorSelect = document.getElementById('edit-dependency-predecessor');
    const typeSelect = document.getElementById('edit-dependency-type');
    const lagInput = document.getElementById('edit-dependency-lag');
    
    if (!predecessorSelect || !typeSelect || !lagInput) return;
    
    const predecessorId = predecessorSelect.value;
    const type = typeSelect.value;
    const lag = parseInt(lagInput.value) || 0;
    
    if (!predecessorId) {
        window.showAlertModal('Wybierz zadanie poprzedzające');
        return;
    }
    
    try {
        const dependencyData = {
            predecessor: parseInt(predecessorId),
            successor: taskId,
            type: type,
            lag_days: lag
        };
        
        await window.WorklyAPI.request('/dependencies/', {
            method: 'POST',
            body: JSON.stringify(dependencyData),
        });
        
        // Reload dependencies list
        const task = await window.WorklyAPI.request(`/tasks/${taskId}/`);
        const projectId = typeof task.project === 'object' ? task.project.id : task.project;
        await loadDependenciesForTask(taskId, projectId);
        
        // Clear form
        predecessorSelect.value = '';
        typeSelect.value = 'FS';
        lagInput.value = '0';
        
        // Reload tasks dropdown
        await loadTasksForDependencyDropdown(projectId, taskId);
    } catch (error) {
        console.error('Error adding dependency:', error);
        let errorMessage = 'Błąd podczas dodawania zależności: ' + error.message;
        
        // Check for specific error messages
        if (error.message && error.message.includes('cykl')) {
            errorMessage = 'Nie można dodać zależności - spowodowałoby to cykl.';
        } else if (error.message && error.message.includes('projekt')) {
            errorMessage = 'Oba zadania muszą należeć do tego samego projektu.';
        } else if (error.message && error.message.includes('samego siebie')) {
            errorMessage = 'Zadanie nie może zależeć od samego siebie.';
        }
        
        window.showAlertModal(errorMessage);
    }
}

// Remove dependency
async function removeDependency(dependencyId, taskId) {
    window.showConfirmModal(
        'Czy na pewno chcesz usunąć tę zależność?',
        async () => {
            try {
                await window.WorklyAPI.request(`/dependencies/${dependencyId}/`, {
                    method: 'DELETE',
                });
                
                // Reload dependencies list
                const task = await window.WorklyAPI.request(`/tasks/${taskId}/`);
                const projectId = typeof task.project === 'object' ? task.project.id : task.project;
                await loadDependenciesForTask(taskId, projectId);
            } catch (error) {
                console.error('Error removing dependency:', error);
                window.showAlertModal('Błąd podczas usuwania zależności: ' + error.message);
            }
        }
    );
}

// Delete task function
async function deleteTask(taskId, event) {
    // Get task title from button data attribute
    const button = event ? event.target.closest('button') : null;
    const taskTitle = button ? button.getAttribute('data-task-title') || 'to zadanie' : 'to zadanie';
    
    window.showConfirmModal(
        `Czy na pewno chcesz usunąć zadanie "${taskTitle}"?`,
        async () => {
            try {
                await window.WorklyAPI.request(`/tasks/${taskId}/`, {
                    method: 'DELETE',
                });
                
                // Reload page to show updated task list
                location.reload();
            } catch (error) {
                console.error('Error deleting task:', error);
                window.showAlertModal('Błąd podczas usuwania zadania: ' + error.message);
            }
        }
    );
}

// Delete project function
async function deleteProject(projectId, event) {
    // Get project name from button data attribute
    const button = event ? event.target.closest('button') : null;
    const projectName = button ? button.getAttribute('data-project-name') || 'ten projekt' : 'ten projekt';
    
    window.showConfirmModal(
        `Czy na pewno chcesz usunąć projekt "${projectName}"?`,
        async () => {
            try {
                await window.WorklyAPI.request(`/projects/${projectId}/`, {
                    method: 'DELETE',
                });
                
                // Redirect to projects list
                window.location.href = projectsListUrl;
            } catch (error) {
                console.error('Error deleting project:', error);
                let errorMessage = 'Błąd podczas usuwania projektu: ' + error.message;
                
                // Check if error is about protected deletion (project has tasks)
                if (error.message && error.message.includes('zadania')) {
                    errorMessage = 'Nie można usunąć projektu, który ma przypięte zadania.';
                }
                
                window.showAlertModal(errorMessage);
            }
        }
    );
}

// Edit project function
async function editProject() {
    try {
        // Load current project data
        const project = await window.WorklyAPI.request(`/projects/${projectId}/`);
        
        // Load users for owner dropdown
        await loadUsersForProjectForm();
        
        // Fill edit form
        document.getElementById('edit-project-name').value = project.name || '';
        document.getElementById('edit-project-description').value = project.description || '';
        document.getElementById('edit-project-start-date').value = project.start_date || '';
        document.getElementById('edit-project-end-date').value = project.end_date || '';
        document.getElementById('edit-project-status').value = project.status || 'active';
        document.getElementById('edit-project-priority').value = project.priority || '2';
        
        // Set owner
        if (project.owner) {
            const ownerId = typeof project.owner === 'object' ? project.owner.id : project.owner;
            document.getElementById('edit-project-owner').value = ownerId || '';
        } else {
            document.getElementById('edit-project-owner').value = '';
        }
        
        // Open modal
        document.getElementById('edit-project-modal').showModal();
    } catch (error) {
        console.error('Error loading project:', error);
        alert('Błąd podczas ładowania projektu: ' + error.message);
    }
}

// Setup edit project modal
function setupEditProjectModal(project) {
    // Add modal HTML if not exists
    if (!document.getElementById('edit-project-modal')) {
        const modalHTML = `
            <dialog id="edit-project-modal" class="modal">
                <div class="modal-box">
                    <h3 class="font-bold text-lg">Edytuj projekt</h3>
                    <form id="edit-project-form" class="mt-4 space-y-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Nazwa projektu <span class="text-error">*</span></span>
                            </label>
                            <input type="text" name="name" id="edit-project-name" class="input input-bordered" required />
                            <label class="label hidden" id="edit-name-error-label">
                                <span class="label-text-alt text-error"></span>
                            </label>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Opis</span>
                            </label>
                            <textarea name="description" id="edit-project-description" class="textarea textarea-bordered"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Data rozpoczęcia <span class="text-error">*</span></span>
                                </label>
                                <input type="date" name="start_date" id="edit-project-start-date" class="input input-bordered" required placeholder="dd.mm.rrrr" />
                                <label class="label hidden" id="edit-start-date-error-label">
                                    <span class="label-text-alt text-error"></span>
                                </label>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Data zakończenia <span class="text-error">*</span></span>
                                </label>
                                <input type="date" name="end_date" id="edit-project-end-date" class="input input-bordered" required placeholder="dd.mm.rrrr" />
                                <label class="label hidden" id="edit-end-date-error-label">
                                    <span class="label-text-alt text-error"></span>
                                </label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Status <span class="text-error">*</span></span>
                                </label>
                                <select name="status" id="edit-project-status" class="select select-bordered">
                                    <option value="planned">Planowany</option>
                                    <option value="active">Aktywny</option>
                                    <option value="on_hold">Wstrzymany</option>
                                    <option value="done">Zakończony</option>
                                    <option value="archived">Zarchiwizowany</option>
                                </select>
                                <label class="label hidden" id="edit-status-error-label">
                                    <span class="label-text-alt text-error"></span>
                                </label>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Priorytet <span class="text-error">*</span></span>
                                </label>
                                <select name="priority" id="edit-project-priority" class="select select-bordered">
                                    <option value="1">Niski</option>
                                    <option value="2">Średni</option>
                                    <option value="3">Wysoki</option>
                                    <option value="4">Krytyczny</option>
                                </select>
                                <label class="label hidden" id="edit-priority-error-label">
                                    <span class="label-text-alt text-error"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Właściciel</span>
                            </label>
                            <select name="owner" id="edit-project-owner" class="select select-bordered">
                                <option value="">Brak</option>
                            </select>
                        </div>
                        <div class="modal-action">
                            <button type="button" onclick="document.getElementById('edit-project-modal').close()" class="btn">Anuluj</button>
                            <button type="submit" class="btn btn-primary">Zapisz</button>
                        </div>
                    </form>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>zamknij</button>
                </form>
            </dialog>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Helper functions for error handling
        function showError(fieldId, errorLabelId, message) {
            const field = document.getElementById(fieldId);
            const errorLabel = document.getElementById(errorLabelId);
            if (field && errorLabel) {
                field.classList.remove('input-bordered');
                field.classList.add('input-error');
                errorLabel.classList.remove('hidden');
                errorLabel.querySelector('span').textContent = message;
                field.setAttribute('title', message);
                field.setAttribute('aria-label', message);
            }
        }
        
        function clearError(fieldId, errorLabelId) {
            const field = document.getElementById(fieldId);
            const errorLabel = document.getElementById(errorLabelId);
            if (field && errorLabel) {
                field.classList.remove('input-error');
                field.classList.add('input-bordered');
                errorLabel.classList.add('hidden');
                field.removeAttribute('title');
                field.removeAttribute('aria-label');
            }
        }
        
        // Clear errors on input change
        document.getElementById('edit-project-start-date').addEventListener('input', () => {
            clearError('edit-project-start-date', 'edit-start-date-error-label');
        });
        
        document.getElementById('edit-project-end-date').addEventListener('input', () => {
            clearError('edit-project-end-date', 'edit-end-date-error-label');
        });
        
        // Setup form handler
        const form = document.getElementById('edit-project-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Clear previous errors
                clearError('edit-project-start-date', 'edit-start-date-error-label');
                clearError('edit-project-end-date', 'edit-end-date-error-label');
                
                let hasError = false;
                
                // Validate start date
                const startDate = document.getElementById('edit-project-start-date').value;
                if (!startDate) {
                    showError('edit-project-start-date', 'edit-start-date-error-label', 'Data rozpoczęcia jest wymagana');
                    hasError = true;
                }
                
                // Validate end date
                const endDate = document.getElementById('edit-project-end-date').value;
                if (!endDate) {
                    showError('edit-project-end-date', 'edit-end-date-error-label', 'Data zakończenia jest wymagana');
                    hasError = true;
                }
                
                if (hasError) {
                    return;
                }
                
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Convert priority to integer
                data.priority = parseInt(data.priority);
                
                // Convert empty owner to null
                if (!data.owner) data.owner = null;
                else data.owner = parseInt(data.owner);
                
                try {
                    await window.WorklyAPI.request(`/projects/${projectId}/`, {
                        method: 'PATCH',
                        body: JSON.stringify(data),
                    });
                    
                    document.getElementById('edit-project-modal').close();
                    // Reload page to show updated project
                    location.reload();
                } catch (error) {
                    alert('Błąd podczas aktualizacji projektu: ' + error.message);
                }
            });
        }
    }
}

// Load users for project form
async function loadUsersForProjectForm() {
    try {
        const users = await window.WorklyAPI.request('/users/');
        const userList = Array.isArray(users) ? users : [];
        const ownerSelect = document.getElementById('edit-project-owner');
        
        if (ownerSelect) {
            const currentValue = ownerSelect.value;
            ownerSelect.innerHTML = '<option value="">Brak</option>';
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.username;
                ownerSelect.appendChild(option);
            });
            if (currentValue) {
                ownerSelect.value = currentValue;
            }
        }
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

</script>
{% endblock %}

