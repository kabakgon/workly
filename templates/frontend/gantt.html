{% extends 'base.html' %}
{% load static %}

{% block title %}Diagram Gantta - Workly 2.0{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{% url 'frontend:project_detail' project_id %}" class="btn btn-ghost btn-sm mb-4">← Powrót do projektu</a>
    <h1 class="text-3xl font-bold">Diagram Gantta</h1>
    <p class="text-base-content/70">Wizualizacja harmonogramu projektu</p>
</div>

<div class="card bg-base-200 shadow-lg">
    <div class="card-body">
        <div id="gantt-container" class="overflow-x-auto">
            <div class="flex justify-center items-center h-64">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>
</div>

<div class="mt-4 alert alert-info">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>Diagram Gantta wymaga biblioteki zewnętrznej (np. dhtmlx-gantt, frappe-gantt). Dane są dostępne w formacie JSON.</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
const projectId = {{ project_id }};

document.addEventListener('DOMContentLoaded', async function() {
    try {
        const ganttData = await window.WorklyAPI.request(`/projects/${projectId}/gantt/`);
        
        const container = document.getElementById('gantt-container');
        container.innerHTML = `
            <div class="space-y-4">
                <h3 class="text-xl font-bold">Zadania (${ganttData.data.length})</h3>
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tytuł</th>
                                <th>Data rozpoczęcia</th>
                                <th>Data zakończenia</th>
                                <th>Postęp</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ganttData.data.map(task => `
                                <tr>
                                    <td>${task.id}</td>
                                    <td class="font-semibold">${task.text}</td>
                                    <td>${window.WorklyAPI.formatDate(task.start_date)}</td>
                                    <td>${window.WorklyAPI.formatDate(task.end_date)}</td>
                                    <td>
                                        <progress class="progress progress-primary w-24" value="${(task.progress || 0) * 100}" max="100"></progress>
                                    </td>
                                    <td>${window.WorklyAPI.getStatusBadge(task.status, 'task')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${ganttData.links.length > 0 ? `
                <div class="mt-6">
                    <h3 class="text-xl font-bold">Zależności (${ganttData.links.length})</h3>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Poprzednik</th>
                                    <th>Typ</th>
                                    <th>Następnik</th>
                                    <th>Opóźnienie (dni)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ganttData.links.map(link => `
                                    <tr>
                                        <td>${link.id}</td>
                                        <td>${link.source}</td>
                                        <td><span class="badge badge-info">${link.type}</span></td>
                                        <td>${link.target}</td>
                                        <td>${link.lag || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-2">Dane JSON</h3>
                    <pre class="bg-base-300 p-4 rounded-lg overflow-x-auto text-xs"><code>${JSON.stringify(ganttData, null, 2)}</code></pre>
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('gantt-container').innerHTML = `
            <div class="alert alert-error">
                <span>Błąd podczas ładowania diagramu Gantta: ${error.message}</span>
            </div>
        `;
    }
});
</script>
{% endblock %}

